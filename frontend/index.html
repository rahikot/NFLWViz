<!DOCTYPE html>
<html>
<head>
  <title>NFL Visualization</title>
  <meta charset="utf-8">
  <script type="text/javascript" src="lib/d3.v5.min.js"></script>
  <script type="text/javascript" src="visualizeGameData.js"></script>
  <script type="text/javascript" src="lib/d3-simple-slider.js"></script>
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
  <h1>NFL Play Visualization</h1>
  <div class = "titleInfo">
    <select id="gameDropdown"></select>
    <p id="gameInfo"></p>
  </div>
  <p id="playInfo"></p>
  
  
  <div id="output"></div>

  <script>

const margin = { top: 20, right: 20, bottom: 20, left: 20 };
    const width = 960 - margin.left - margin.right;
    const height = 960 - margin.top - margin.bottom;

    // all svg's should be inside mainSvg
    const mainSvg = d3.select("#output")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    const imageUrl = 'NFLField.png';
    image = mainSvg.append("image")
        .attr("xlink:href", imageUrl)
        .attr("x", 0) // X-coordinate of the image
        .attr("y", 100) // Y-coordinate of the image
        .attr("width", 900) // Width of the image
        .attr("height", 500); // Height of the image




    var football = mainSvg.append("rect")
          //.attr("x", 81) // X-coordinate of the square
          //.attr("y", 535) // Y-coordinate of the square
          .attr("width", 10) // Width of the square
          .attr("height", 10) // Height of the square
          .attr("fill", "brown"); // Fill color of the square

    bottomLeft = [81, 535]
    topRight = [816 , 155]
    // svg holding name of teams (TODO: add score and which is home/away team)
    const textSvg = mainSvg.append("svg")
      .attr("x", 240)
      .attr("y", 50)
      .attr("width", 500)
      .attr("height", 200);

    //displayTeams(textSvg, "TB", "DAL")


    var sliderGroup = mainSvg.append('g')
    .attr('transform', 'translate(0,600)');

    var slider = d3.sliderHorizontal()
        .step(1)
        .width(900)
        .displayValue(true)
        .on('onchange', function(val) {
            d3.select('#value').text(val);
        });


    //Note: this does not include all columns, some were excluded since I didn't see their use

    var weekData = d3.csv("week1.csv", function(d) {
      return {
        gameId: +d.gameId,
        playId: +d.playId,
        frameId: +d.frameId,
        time: new Date(d.time),
        team: d.team,
        playDirection: d.playDirection,
        x: +d.x,
        y: +d.y,
        s: +d.s,
        a: +d.a,
        dis: +d.dis,
        o: +d.o,
        dir: +d.dir,
        event: d.event
      };
    })
    
    var gameData = d3.csv("games.csv")
    var playData = d3.csv("plays.csv")

    Promise.all([
      weekData, gameData, playData
    ]).then(
      function(values){
                var error = ""
                ready("", values[0], values[1], values[2])
          }
  
    );


    function ready(error, weekData, gameData, playData) {
      const dataDictionary = {};

      var gameDatabyId = {}
      gameData.forEach(rowData => {
        gameDatabyId[rowData.gameId] = rowData
      })

      weekData.forEach((row, index) => {
        dataDictionary[index] = row;
      })
      
      footballData = {}
      Object.keys(dataDictionary).forEach(rowNumber => {
        const rowData = dataDictionary[rowNumber]
        if (rowData.team === "football") {
          footballData[rowNumber] = rowData
        }
      })




      let dataByGameId = {}

      weekData.forEach((row, index) => {
          const gameId = row.gameId;
          const playId = row.playId;
          newCoordinates = scaleCoordinates(row.x, row.y)
          row.x = newCoordinates[0];
          row.y = newCoordinates[1];

          if (!dataByGameId[gameId]) {
              dataByGameId[gameId] = {};
          }

          if (!dataByGameId[gameId].rows) {
              dataByGameId[gameId].rows = {};
          }

          if (!dataByGameId[gameId].rows[index]) {
            dataByGameId[gameId].rows[index] = []
          }
          dataByGameId[gameId].rows[index].push(row);

          if (!dataByGameId[gameId].playIdToRows) {
              dataByGameId[gameId].playIdToRows = {};
          }

          if (!dataByGameId[gameId].playIdToRows[playId]) {
              dataByGameId[gameId].playIdToRows[playId] = [];
          }

          dataByGameId[gameId].playIdToRows[playId].push(row);
      });

      // var plays = {}
      // playData.forEach(rowData => {
      //   var time = rowData.gameClock.split(":")
      //   var min = parseInt(time[0], 10) * 60
      //   var sec = parseInt(time[1], 10)
      //   var timeSec = min + sec
      //   rowData.gameClock = timeSec
      // })
      // console.log(playData)
      // playData.sort(function(a,b){
      //   return a.gameClock - b.gameClock
      // })
      // function closestPlay(data, val) {
      //   return data.reduce((a,b) => {
      //     return Math.abs(b.gameClock - val) < Math.abs(a.gameClock - val) ? b : a
      // //   })
      // }


      var TBvsDALGame = dataByGameId[2021090900]
      var playDat = TBvsDALGame.playIdToRows
      var specificPlays = 480
      var interval = 100

      //visualizePlay(playDat, specificPlays, football, interval);

      
      // slider.on('onchange', function(val) {
      //       d3.select('#value').text(val);
      //       var c = closestPlay(playData, val)
      //   d3.select("#playInfo").text(c.gameClock)
      //   });
      
      
      d3.select("#gameDropdown").selectAll('option')
            .data(gameData)
            .enter()
            .append('option')
            .text(function(d){
                return d.homeTeamAbbr + " vs. " + d.visitorTeamAbbr
            })
            .attr("value", function(d){
                return d.gameId
            })
      let selectedGameId;
      let sliderMapping = {}
      d3.select("#gameDropdown").on('change', function() {
        selectedGameId = d3.select(this).property('value');
        displayTeams(textSvg, gameDatabyId[selectedGameId].homeTeamAbbr,gameDatabyId[selectedGameId].visitorTeamAbbr)
        d3.select("#gameInfo").text( "Season: "+  gameDatabyId[selectedGameId].season + " Game Date: "+ gameDatabyId[selectedGameId].gameDate + " Game Time: " + gameDatabyId[selectedGameId].gameTimeEastern)
        sliderMapping = getSliderMapping(dataByGameId[selectedGameId].playIdToRows)
        slider.min(0).max(Object.keys(sliderMapping).length - 1)
        sliderGroup.call(slider);
      })


      slider.on('end', function(value) {

          visualizePlay(dataByGameId[selectedGameId].playIdToRows, sliderMapping[value], football, interval);
  });


  }
    

  </script>
</body>
</html>

